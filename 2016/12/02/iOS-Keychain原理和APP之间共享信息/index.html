<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>iOS Keychain原理和APP之间共享信息 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Keychain 介绍Keychain Services 是 MacOS 和 iOS 都提供一种安全地存储敏感信息的工具，比如,网络密码:用于保存访问服务器或者网站,通用密码:用来保存应用程序或者数据库密码.与此同时,用于认证的证书,密钥,和身份信息,也可以存储在Keychain中.Keychain Services 的安全机制保证了存储这些敏感信息不会被窃取。简单说来，Keychain 就是一个">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS Keychain原理和APP之间共享信息">
<meta property="og:url" content="http://yoursite.com/2016/12/02/iOS-Keychain原理和APP之间共享信息/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Keychain 介绍Keychain Services 是 MacOS 和 iOS 都提供一种安全地存储敏感信息的工具，比如,网络密码:用于保存访问服务器或者网站,通用密码:用来保存应用程序或者数据库密码.与此同时,用于认证的证书,密钥,和身份信息,也可以存储在Keychain中.Keychain Services 的安全机制保证了存储这些敏感信息不会被窃取。简单说来，Keychain 就是一个">
<meta property="og:image" content="https://static.oschina.net/uploads/img/201612/02110610_w8pY.png">
<meta property="og:image" content="https://static.oschina.net/uploads/img/201612/02110610_w8pY.png">
<meta property="og:image" content="https://static.oschina.net/uploads/img/201612/02111137_MbnO.png">
<meta property="og:image" content="https://static.oschina.net/uploads/img/201612/02111211_v1lj.png">
<meta property="og:updated_time" content="2016-12-02T07:04:06.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS Keychain原理和APP之间共享信息">
<meta name="twitter:description" content="Keychain 介绍Keychain Services 是 MacOS 和 iOS 都提供一种安全地存储敏感信息的工具，比如,网络密码:用于保存访问服务器或者网站,通用密码:用来保存应用程序或者数据库密码.与此同时,用于认证的证书,密钥,和身份信息,也可以存储在Keychain中.Keychain Services 的安全机制保证了存储这些敏感信息不会被窃取。简单说来，Keychain 就是一个">
<meta name="twitter:image" content="https://static.oschina.net/uploads/img/201612/02110610_w8pY.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Zoeken"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="[default]-iOS-Keychain原理和APP之间共享信息" class="article article-type-[default]" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/02/iOS-Keychain原理和APP之间共享信息/" class="article-date">
  <time datetime="2016-12-02T07:01:20.000Z" itemprop="datePublished">2016-12-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      iOS Keychain原理和APP之间共享信息
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Keychain-介绍"><a href="#Keychain-介绍" class="headerlink" title="Keychain 介绍"></a>Keychain 介绍</h2><p>Keychain Services 是 MacOS 和 iOS 都提供一种安全地存储敏感信息的工具，比如,网络密码:用于保存访问服务器或者网站,通用密码:用来保存应用程序或者数据库密码.与此同时,用于认证的证书,密钥,和身份信息,也可以存储在Keychain中.Keychain Services 的安全机制保证了存储这些敏感信息不会被窃取。简单说来，Keychain 就是一个安全容器。<br><em>PS:在iOS中keychian 依赖用于签名的provisioning profile描述文件,确保发布不同版本的时候使用同一个pp文件</em><br><img src="https://static.oschina.net/uploads/img/201612/02110610_w8pY.png" alt="输入图片说明" title="在这里输入图片标题"></p>
<h2 id="Keychain-的结构"><a href="#Keychain-的结构" class="headerlink" title="Keychain 的结构"></a>Keychain 的结构</h2><p>Keychain 可以包含任意数量的 keychain item。每一个 keychain item 包含数据和一组属性。对于一个需要保护的 keychain item，比如密码或者私钥（用于加密或者解密的string字节）数据是加密的，会被 keychain 保护起来的；对于无需保护的 keychain item，例如，证书，数据未被加密。</p>
<p>跟keychain item有关系的取决于item的类型；应用程序中最常用的是网络密码（Internet passwrods）和普通的密码。正如你所想的，网络密码像安全域（security domain）、协议、和路径等一些属性。在OSX中，当keychain被锁的时候加密的item没办法访问，如果你想要该问被锁的item，就会弹出一个对话框，需要你输入对应keychain的密码。当然，未有密码的keychain你可以随时访问。但在iOS中，你只可以访问你自已的keychain items;</p>
<h2 id="Keychain的特点"><a href="#Keychain的特点" class="headerlink" title="Keychain的特点"></a>Keychain的特点</h2><ul>
<li>数据并不存放在App的Sanbox中，即使删除了App，资料依然保存在keychain中。如果重新安装了app，还可以从keychain获取数据。</li>
<li>keychain的数据可以用过group方式，让程序可以在App间共享。不过得要相同TeamID</li>
<li><p>keychain的数据是经过加密的<br>##Keychain的使用<br>大多数iOS应用需要用到Keychain， 都用来添加一个密码，修改一个已存在Keychain item或者取回密码。Keychain提供了以下的操作</p>
</li>
<li><p>SecItemAdd 添加一个item</p>
</li>
<li>SecItemUpdate 更新已存在的item</li>
<li>SecItemCopyMatching 搜索一个已存在的item</li>
<li>SecItemDelete 删除一个keychain item</li>
</ul>
<p>####读取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">func readPassword() throws -&gt; String  &#123;</div><div class="line">       /*</div><div class="line">           查找 对应 service, account and</div><div class="line">           access group 的keychainItem.</div><div class="line">       */</div><div class="line">       var query = KeychainPasswordItem.keychainQuery(withService: service, account: account, accessGroup: accessGroup)</div><div class="line">       query[kSecMatchLimit as String] = kSecMatchLimitOne</div><div class="line">       query[kSecReturnAttributes as String] = kCFBooleanTrue</div><div class="line">       query[kSecReturnData as String] = kCFBooleanTrue</div><div class="line">       </div><div class="line">       // 查找已经存在的item</div><div class="line">       var queryResult: AnyObject?</div><div class="line">       let status = withUnsafeMutablePointer(to: &amp;queryResult) &#123;</div><div class="line">           SecItemCopyMatching(query as CFDictionary, UnsafeMutablePointer($0))</div><div class="line">       &#125;</div><div class="line">       </div><div class="line">       // 检查插入或更新是否成功</div><div class="line">       guard status != errSecItemNotFound else &#123; throw KeychainError.noPassword &#125;</div><div class="line">       guard status == noErr else &#123; throw KeychainError.unhandledError(status: status) &#125;</div><div class="line">       </div><div class="line">       // 读取item中的密码信息</div><div class="line">       guard let existingItem = queryResult as? [String : AnyObject],</div><div class="line">           let passwordData = existingItem[kSecValueData as String] as? Data,</div><div class="line">           let password = String(data: passwordData, encoding: String.Encoding.utf8)</div><div class="line">       else &#123;</div><div class="line">           throw KeychainError.unexpectedPasswordData</div><div class="line">       &#125;</div><div class="line">       </div><div class="line">       return password</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>####写入</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">func savePassword(_ password: String) throws &#123;</div><div class="line">        // 编码Encoding-&gt;data</div><div class="line">        let encodedPassword = password.data(using: String.Encoding.utf8)!</div><div class="line">        </div><div class="line">        do &#123;</div><div class="line">            // 查找是否存在item.</div><div class="line">            try _ = readPassword()</div><div class="line"></div><div class="line">            // 如果存在更新item中的密码</div><div class="line">            var attributesToUpdate = [String : AnyObject]()</div><div class="line">            attributesToUpdate[kSecValueData as String] = encodedPassword as AnyObject?</div><div class="line"></div><div class="line">            let query = KeychainPasswordItem.keychainQuery(withService: service, account: account, accessGroup: accessGroup)</div><div class="line">            let status = SecItemUpdate(query as CFDictionary, attributesToUpdate as CFDictionary)</div><div class="line">            </div><div class="line">          </div><div class="line">            guard status == noErr else &#123; throw KeychainError.unhandledError(status: status) &#125;</div><div class="line">        &#125;</div><div class="line">        catch KeychainError.noPassword &#123;</div><div class="line">            /*</div><div class="line">                如果不存在 创建一个dictionary 作为item 存入keychain</div><div class="line">            */</div><div class="line">            var newItem = KeychainPasswordItem.keychainQuery(withService: service, account: account, accessGroup: accessGroup)</div><div class="line">            newItem[kSecValueData as String] = encodedPassword as AnyObject?</div><div class="line">   </div><div class="line">            let status = SecItemAdd(newItem as CFDictionary, nil)</div><div class="line">            </div><div class="line">            guard status == noErr else &#123; throw KeychainError.unhandledError(status: status) &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</code></pre><p>##关于共享<br>Keychain的数据可以透过Group Access的方式，让资料可以在App间共享，Google系列的App (Gmail、Google+、日历…)就是通过这样的方式来记录使用者登入信息，只要使用者在其中一个App中完成登入了，其他的App也可以读取到同相的登入咨询进行登录。</p>
<p>###进入Capabilities，将Keychain打开<br><img src="https://static.oschina.net/uploads/img/201612/02110610_w8pY.png" alt="输入图片说明" title="在这里输入图片标题"></p>
<p>开启Keychain后，会自动新增一个Keychain Group，使用的是Bundle Identifier。<br>同时也会自动新增一个entitlements文件，里面也会有一个Access Group，名为<br>$(AppIdentifierPrefix)+你的bundleID<br><img src="https://static.oschina.net/uploads/img/201612/02111137_MbnO.png" alt="输入图片说明" title="在这里输入图片标题"></p>
<p>(AppIdentifierPrefix)可以是开发者的代号需要登录才会有，也就是开发者证书后小括号的内的英文数字组合。使用$(AppIdentifierPrefix)只能被同一个开发者账号的app来存取，以防被有心人盜取。<br><img src="https://static.oschina.net/uploads/img/201612/02111211_v1lj.png" alt="输入图片说明" title="在这里输入图片标题"></p>
<p>若其他的App也要存取当前Keychain的数据，就必需在Keychain开启后，新增相同的Keychain Group (Access Group会根据Keychain Group自动新增)。<br><em>PS: 需要Info.plist新增一对键值<br>Key: AppIdentifierPrefix<br>Value: $(AppIdentifierPrefix)<br>方便取得 Identifier Prefix</em></p>
<p><a href="https://developer.apple.com/library/prerelease/content/samplecode/GenericKeychain/Introduction/Intro.html#//apple_ref/doc/uid/DTS40007797" target="_blank" rel="external">官方sampleCode</a></p>
<p>如有疑问可以加我QQ451912132</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/02/iOS-Keychain原理和APP之间共享信息/" data-id="ciw7glp460000bhc1mm7d8owm" class="article-share-link">Delen</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/11/30/手把手教你-Jenkins构建iOS项目/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ouder</strong>
      <div class="article-nav-title">手把手教你, Jenkins构建iOS项目</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archieven</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recente berichten</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/12/02/iOS-Keychain原理和APP之间共享信息/">iOS Keychain原理和APP之间共享信息</a>
          </li>
        
          <li>
            <a href="/2016/11/30/手把手教你-Jenkins构建iOS项目/">手把手教你, Jenkins构建iOS项目</a>
          </li>
        
          <li>
            <a href="/2016/11/30/用xcode-archive-导出ipa-然后上传到fir-蒲公英等测试平台-需要花至少10到20分钟-使用Jenkins搭建的持续集成环境只需3分钟/">用xcode archive 导出ipa 然后上传到fir/蒲公英等测试平台 需要花至少10到20分钟,使用Jenkins搭建的持续集成环境只需3分钟.</a>
          </li>
        
          <li>
            <a href="/2016/11/24/Swift-的Guard/">Swift 的Guard</a>
          </li>
        
          <li>
            <a href="/2016/11/24/在xib或者storyboard-利用runtime给layer添加属性的坑/">在xib或者storyboard 利用runtime给layer添加属性的坑</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>